import datetime as dt
import pytest
from tyche.quote import Quote


option_path = '../../option_history/'
quote_path = '../../quote_history/'
symbols = {'TEAM', 'MS', 'TLT'}
sample_rows = {
    'TEAM': [
        '3571,TEAM,2018-08-01,72.5,74.555,72.41,73.29,1358735,73.29',
        '3526,TEAM,2018-07-11,64.01,65.6,64.0,65.33,453422,65.33',
        '3568,TEAM,2018-11-21,73.11,73.21,70.09100000000001,72.13,826413,72.13',
        '3519,TEAM,2019-04-02,114.44,116.09,112.22,115.6,978142,115.6',
        '3540,TEAM,2019-01-17,94.33,94.75,91.65700000000001,92.92,3168054,92.92',
        '3522,TEAM,2019-05-29,124.18,125.29,122.57,123.8,1533931,123.8',
        '3528,TEAM,2019-05-31,123.82,127.3385,122.67,125.88,1071950,125.88'
    ],
    'MS': [
        '2451,MS,2018-08-01,50.94,51.18,50.04,50.18,8639963,50.18',
        '2419,MS,2018-07-11,47.64,48.07,47.585,47.75,6039224,47.4693927522037',
        '2456,MS,2018-11-21,43.29,44.225,43.15,43.73,7856363,43.73',
        '2418,MS,2019-04-02,43.43,43.888999999999996,43.21,43.7,12883752,43.7',
        '2427,MS,2019-01-17,42.45,43.18,41.61,42.53,46838015,42.53',
        '2434,MS,2019-05-29,41.74,42.24,41.565,42.19,9672587,42.19',
        '2438,MS,2019-05-31,41.11,41.28,40.6,40.69,11137984,40.69'
    ],
    'TLT': [
        '3625,TLT,2018-08-01,118.285,118.835,118.07,118.46,13255258,118.46',
        '3578,TLT,2018-07-11,122.45,122.55,122.09,122.42,6715291,122.14693283208',
        '3624,TLT,2018-11-21,114.89,115.09,114.54,115.02,4938735,115.02',
        '3574,TLT,2019-04-02,124.48,124.7369,124.245,124.6,9712006,124.6',
        '3597,TLT,2019-01-17,120.22,120.53,119.89,120.19,8147451,120.19',
        '3579,TLT,2019-05-29,129.67,129.9,129.0,129.09,12822288,129.09',
        '3585,TLT,2019-05-31,130.9,131.9,130.81,131.83,17807857,131.83'
    ]
}


@pytest.mark.parametrize("symbol", symbols)
def test_get_by_opra(symbol):
    quote = Quote(symbol, quote_path)
    for row in sample_rows[symbol]:
        cols = row.split(',')
        cur_yr, cur_mo, cur_day = cols[2].split('-')
        current_date = dt.datetime(year=int(cur_yr), month=int(cur_mo), day=int(cur_day))
        quote.set_current_date(current_date)
        x = quote.get_by_opra(symbol)
        assert x['symbol'] == symbol
        assert x['quotedate'] == current_date
        assert x['close'] == float(cols[6])
        assert x['volume'] == float(cols[7])
